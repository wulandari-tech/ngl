<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>share wanzofc</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <style>
      *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
      body { font-family: 'Roboto Mono', monospace; background-color: #000; color: #fff; line-height: 1.6; overflow-x: hidden;  padding-bottom: 50px;}
      h1, h2 { font-family: 'Poppins', sans-serif; text-align: center; margin-bottom: 1rem; color: #00ffff; text-shadow: 0 0 10px rgba(0, 255, 255, 0.8); }
      h1 { font-size: 2.5rem; margin-top: 2rem; margin-bottom: 2rem;}
      #container-utama, #container-file { display: flex; flex-direction: column; gap: 2rem; padding: 20px; max-width: 900px; margin: 0 auto; }
      .kontainer-kode { background-color: rgba(255, 255, 255, 0.1); border: 1px solid rgba(0, 255, 255, 0.5); border-radius: 8px; padding: 1.5rem; position: relative; overflow: hidden; transition: transform 0.3s ease, box-shadow 0.3s ease; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5); }
      .kontainer-kode:hover { transform: translateY(-5px); box-shadow: 0 6px 12px rgba(0, 255, 255, 0.3); }
      .kontainer-kode pre { white-space: pre-wrap; word-wrap: break-word; font-size: 0.9rem; color: #eee; line-height: 1.4; max-height: 150px; overflow: hidden; transition: max-height 0.5s ease; }
      .kontainer-kode.expanded pre { max-height: 1000px; }
      .kontainer-kode .tombol-copy { position: absolute; top: 10px; right: 10px; background-color: #00ffff; color: #000; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight: bold; transition: background-color 0.3s, transform 0.3s; }
      .kontainer-kode .tombol-copy:hover { background-color: #00d1d1; transform: scale(1.05); }
      .kontainer-kode .judul-kode { font-size: 1.2rem; color: #00ffff; margin-bottom: 0.5rem; }
      .kontainer-file { background-color: rgba(255, 255, 255, 0.1); border: 1px solid rgba(0, 255, 255, 0.5); border-radius: 8px; padding: 1.5rem; position: relative; overflow: hidden; transition: transform 0.3s ease, box-shadow 0.3s ease; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5); margin-bottom: 1rem;}
      .kontainer-file:hover { transform: translateY(-5px); box-shadow: 0 6px 12px rgba(0, 255, 255, 0.3); }
      .kontainer-file .file-link { color: #00ffff; text-decoration: none; font-weight: bold; display: inline-block; transition: color 0.3s, transform 0.3s; }
      .kontainer-file .file-link::before { content: '\f019'; font-family: 'Font Awesome 5 Free'; font-weight: 900; margin-right: 8px; }
      .kontainer-file .file-link:hover { color: #00d1d1; transform: translateX(5px); }
      .kontainer-file .judul-file { font-size: 1.2rem; color: #00ffff; margin-bottom: 0.5rem; }
      #particles-js { position: fixed; width: 100%; height: 100%; top: 0; left: 0; z-index: -1; }
      .modal { display: none; position: fixed; z-index: 10; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8); }
      .modal-konten { background-color: #111; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 800px; border-radius: 8px; position: relative; }
      .modal-konten pre{ white-space: pre-wrap; word-wrap: break-word; font-size: 0.9rem; color: #eee; line-height: 1.4; }
      .tutup-modal { color: #aaa; position: absolute; top: 10px; right: 15px; font-size: 28px; font-weight: bold; cursor: pointer; }
      .tutup-modal:hover, .tutup-modal:focus { color: #fff; text-decoration: none; }
      .tombol-load-more { background-color: transparent; color: #00ffff; border: 2px solid #00ffff; padding: 5px 10px; border-radius: 4px; cursor: pointer; transition: background-color 0.3s, color 0.3s; display: block; margin: 10px auto 0; font-size: 0.8rem;}
      .tombol-load-more:hover { background-color: #00ffff; color: #000; }
      .judul-kode-modal, .judul-file-modal { font-size: 1.5rem; color: #00ffff; margin-bottom: 1rem; border-bottom: 2px solid rgba(0, 255, 255, 0.5); padding-bottom: 0.5rem;}
      .info-count { font-size: 0.8rem; color: rgba(255, 255, 255, 0.7); margin-top: 0.5rem; display: flex; align-items: center; gap: 10px; }
      .copy-count, .download-count, .like-count, .comment-count { margin-left: 5px; display: flex; align-items: center; }
      .copy-count::before { content: '\f0c5'; font-family: 'Font Awesome 5 Free'; font-weight: 900; margin-right: 5px; }
      .download-count::before { content: '\f019'; font-family: 'Font Awesome 5 Free'; font-weight: 900; margin-right: 5px; }
      .like-count::before { content: '\f164'; font-family: 'Font Awesome 5 Free'; font-weight: 900; margin-right: 5px; cursor: pointer; }
      /* Gaya untuk tombol like yang sudah di-like */
        .like-count.liked::before {
          color: red; /* Warna merah untuk like yang sudah di-klik */
        }
      .comment-count::before { content: '\f075'; font-family: 'Font Awesome 5 Free'; font-weight: 900; margin-right: 5px; }
      .komentar-container { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(0, 255, 255, 0.3); }
      .komentar-item { margin-bottom: 0.8rem; padding: 0.5rem; border-radius: 4px; background-color: rgba(255, 255, 255, 0.05); }
      .komentar-author { font-weight: bold; color: #00ffff; }
      .komentar-text { color: #ddd; }
      .komentar-form { margin-top: 1rem; }
      .komentar-form input[type="text"], .komentar-form textarea { width: 100%; padding: 8px; margin-bottom: 10px; border-radius: 4px; border: 1px solid rgba(0, 255, 255, 0.5); background-color: rgba(255, 255, 255, 0.1); color: #fff; font-family: 'Roboto Mono', monospace; }
      .komentar-form button { background-color: #00ffff; color: #000; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; transition: background-color 0.3s; }
      .komentar-form button:hover { background-color: #00d1d1; }
      .file-preview { margin-top: 1rem; text-align: center; }
      .file-preview img { max-width: 100%; max-height: 200px; border-radius: 4px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5); }
      .file-preview a { color: #00ffff; text-decoration: none; }
      /* Tombol Share */
        .tombol-share {
            background-color: transparent;
            color: #00ffff;
            border: none;
            padding: 0;
            font-size: 1rem; /* Sesuaikan ukuran */
            cursor: pointer;
            margin-left: 5px; /* Sesuaikan margin */
            display: flex; /* Menggunakan flexbox untuk center icon */
            align-items: center; /* Center vertically */
        }

        .tombol-share i {
            margin-right: 0; /* Hapus margin jika tidak diperlukan */
        }
        .tombol-share:hover {
            color: #00d1d1; /* Warna hover */
        }
    </style>
</head>
<body>
    <div id="particles-js"></div>
    <h1>TEMPLATE HTML</h1>
    <div id="container-utama"></div>

    <h1>FOR FILE</h1>
    <div id="container-file"></div>

    <div id="modal-kode" class="modal">
        <div class="modal-konten">
            <span class="tutup-modal">Ã—</span>
             <h2 class="judul-kode-modal"></h2>
            <pre></pre>
        </div>
    </div>

    <script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <script>
      particlesJS("particles-js", { "particles": { "number": { "value": 80, "density": { "enable": true, "value_area": 800 } }, "color": { "value": "#00ffff" }, "shape": { "type": "circle", "stroke": { "width": 0, "color": "#000000" }, }, "opacity": { "value": 0.7, "random": true, "anim": { "enable": true, "speed": 1, "opacity_min": 0.1, "sync": false } }, "size": { "value": 4, "random": true, "anim": { "enable": true, "speed": 3, "size_min": 0.1, "sync": false } }, "line_linked": { "enable": true, "distance": 150, "color": "#00ffff", "opacity": 0.4, "width": 1 }, "move": { "enable": true, "speed": 2, "direction": "none", "random": true, "straight": false, "out_mode": "out", "bounce": false, } }, "interactivity": { "detect_on": "canvas", "events": { "onhover": { "enable": true, "mode": "repulse" }, "onclick": { "enable": false, "mode": "push" }, "resize": true }, "modes": { "repulse": { "distance": 100, "duration": 0.4 } } }, "retina_detect": true });

        const modal = document.getElementById('modal-kode');
        const tutupModal = document.querySelector('.tutup-modal');
        const modalPre = document.querySelector('#modal-kode pre');
        const judulModal = document.querySelector('#modal-kode .judul-kode-modal')

        tutupModal.addEventListener('click', () => { modal.style.display = 'none'; });
        window.addEventListener('click', (event) => { if (event.target === modal) { modal.style.display = 'none'; } });

       function buatKontainerKode(item) {
            const containerUtama = document.getElementById('container-utama');
            const kontainerKode = document.createElement('div');
            kontainerKode.classList.add('kontainer-kode');

            const judul = document.createElement('h2');
            judul.textContent = item.judul;
            judul.classList.add('judul-kode');
            kontainerKode.appendChild(judul);

            const pre = document.createElement('pre');
            const code = document.createElement('code');
            code.textContent = item.kode;
            pre.appendChild(code);
            kontainerKode.appendChild(pre);
            hljs.highlightElement(code);


            //Tombol Load More
            if (item.kode.length > 200) {
                const tombolLoadMore = document.createElement('button');
                tombolLoadMore.textContent = 'Load More';
                tombolLoadMore.classList.add('tombol-load-more');
                tombolLoadMore.addEventListener('click', () => {
                  modalPre.textContent = item.kode;
                  judulModal.textContent = item.judul;
                  modal.style.display = 'block';
                });
                kontainerKode.appendChild(tombolLoadMore);
            }

            const tombolCopy = document.createElement('button');
            tombolCopy.textContent = 'Copy';
            tombolCopy.classList.add('tombol-copy');
            tombolCopy.addEventListener('click', async () => {
                try {
                    await navigator.clipboard.writeText(item.kode);
                    gsap.to(tombolCopy, { duration: 0.2, scale: 1.1, yoyo: true, repeat: 1 });
                    alert('Kode berhasil disalin!');

                    const response = await fetch(`/api/kode/${item.id}/copy`, { method: 'POST' });
                    if (response.ok) {
                        const data = await response.json();
                         // Perbarui tampilan copyCount (jika ada)
                        const copyCountEl = kontainerKode.querySelector('.copy-count');
                        if (copyCountEl) {
                            copyCountEl.textContent = data.copyCount;
                        }
                    } else {
                        const errorData = await response.json();
                        alert(errorData.message || 'Gagal menyalin kode.'); // Tampilkan pesan error
                    }
                } catch (err) {
                    console.error('Gagal menyalin:', err);
                }

            });
            kontainerKode.appendChild(tombolCopy);

            const infoCount = document.createElement('div');
            infoCount.classList.add('info-count');

            const copyCount = document.createElement('span');
            copyCount.classList.add('copy-count');
            copyCount.textContent = item.copyCount; // Use item.copyCount directly
            infoCount.appendChild(copyCount);


            const likeCount = document.createElement('span');
            likeCount.classList.add('like-count');
            likeCount.textContent = item.likes; // Gunakan item.likes

            // Cek apakah user sudah like (berdasarkan IP, diasumsikan sudah disimpan di backend)
            // Anda mungkin perlu mengirim request GET terpisah untuk ini, atau
            // menyertakan informasi ini dalam data awal.  Untuk contoh ini,
            // saya asumsikan `likedBy` sudah ada di `item`.
            if (item.likedBy && item.likedBy.includes(getUserIP())) { // Fungsi getUserIP() perlu Anda definisikan
                likeCount.classList.add('liked'); // Tambahkan class 'liked'
            }

            likeCount.addEventListener('click', async () => {
                try {
                    const response = await fetch(`/api/kode/${item.id}/like`, { method: 'POST' });
                    if (response.ok) {
                        const data = await response.json();
                        likeCount.textContent = data.likes;
                         // Perbarui class 'liked' berdasarkan respons dari server
                        if (data.liked) {
                            likeCount.classList.add('liked');
                        } else {
                            likeCount.classList.remove('liked');
                        }
                    }  else {
                        const errorData = await response.json(); // Ambil pesan error
                        alert(errorData.message || 'Gagal menyukai kode.'); // Tampilkan pesan error
                    }
                } catch (error) {
                    console.error('Gagal like:', error);
                }
            });
            infoCount.appendChild(likeCount);



            const commentCount = document.createElement('span');
            commentCount.classList.add('comment-count');
            commentCount.textContent = item.comments.length;  // Gunakan item.comments.length
            infoCount.appendChild(commentCount);



            // --- Tombol Share ---
            const tombolShare = document.createElement('button');
            tombolShare.classList.add('tombol-share');
            tombolShare.innerHTML = '<i class="fas fa-share"></i>'; // Ikon share
            tombolShare.addEventListener('click', async () => {
                try {
                    const response = await fetch(`/api/kode/${item.id}/share`);
                    if (response.ok) {
                        const data = await response.json();
                        alert('Bagikan link ini: ' + data.shareUrl); // Tampilkan URL share
                        // Atau, gunakan cara yang lebih baik untuk menampilkan URL (misalnya, modal)
                    } else {
                        const errorData = await response.json();
                        alert(errorData.message || "Gagal Generate Link");
                    }
                } catch (error) {
                    console.error('Gagal mendapatkan URL share:', error);
                }
            });
            infoCount.appendChild(tombolShare); // Tambah tombol share ke infoCount


            kontainerKode.appendChild(infoCount);


            // --- Komentar ---

            const komentarContainer = document.createElement('div');
            komentarContainer.classList.add('komentar-container');

            const komentarList = document.createElement('div');
            komentarList.classList.add('komentar-list');
            komentarContainer.appendChild(komentarList);

            const komentarForm = document.createElement('form');
            komentarForm.classList.add('komentar-form');
            komentarForm.innerHTML = `
                <input type="text" name="author" placeholder="Nama Anda" required>
                <textarea name="text" placeholder="Komentar Anda" required></textarea>
                <button type="submit">Kirim Komentar</button>
            `;

            komentarForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                const author = komentarForm.elements.author.value;
                const text = komentarForm.elements.text.value;

                if (!author || !text) {
                  alert("Nama dan Komentar Harus Di isi");
                  return;
                }

                try {
                    const response = await fetch(`/api/kode/${item.id}/comments`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ author, text }),
                    });
                    if (response.ok) {
                        const newComment = await response.json();
                        tampilkanKomentar(newComment, komentarList);
                        komentarForm.reset();
                         // Update jumlah komentar
                        commentCount.textContent = parseInt(commentCount.textContent) + 1;
                    } else {
                        throw new Error('Gagal mengirim komentar.');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Terjadi kesalahan saat mengirim komentar.');
                }
            });
            komentarContainer.appendChild(komentarForm);
            kontainerKode.appendChild(komentarContainer);

            function tampilkanKomentar(comment, container) {
              const komentarItem = document.createElement('div');
              komentarItem.classList.add('komentar-item');
              komentarItem.innerHTML = `
                  <p class="komentar-author">${comment.author}</p>
                  <p class="komentar-text">${comment.text}</p>
              `;
              container.appendChild(komentarItem);
            }

            async function ambilKomentar(kodeId, container) {
              try {
                  const response = await fetch(`/api/kode/${kodeId}/comments`);
                  if (response.ok) {
                      const comments = await response.json();
                      comments.forEach(comment => tampilkanKomentar(comment, container));
                  } else {
                      throw new Error('Gagal mengambil komentar.');
                  }
              } catch (error) {
                  console.error('Error:', error);
              }
            }

            ambilKomentar(item.id, komentarList);

            containerUtama.appendChild(kontainerKode);
            gsap.from(kontainerKode, { duration: 0.5, opacity: 0, y: 50, ease: "power2.out" });
        }

        async function ambilDataKode() {
            try {
                const response = await fetch('/api/kode');
                if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
                const data = await response.json();
                 // Urutkan berdasarkan timestamp (terbaru dulu)
                data.sort((a, b) => b.timestamp - a.timestamp);
                data.forEach(item => { buatKontainerKode(item); });
            } catch (error) { console.error('Gagal mengambil data:', error); }
        }

        function buatKontainerFile(item) {
          const containerFile = document.getElementById('container-file');
          const kontainerFile = document.createElement('div');
          kontainerFile.classList.add('kontainer-file');

          const judulFile = document.createElement('h2');
          judulFile.textContent = item.filename; // Use item.filename directly
          judulFile.classList.add('judul-file');
          kontainerFile.appendChild(judulFile);

          const fileLink = document.createElement('a');
          fileLink.textContent = item.filename; // Use item.filename
          fileLink.href = '#'; // Placeholder, akan diganti dengan URL download
          fileLink.classList.add('file-link');

          fileLink.addEventListener('click', async (event) => {
              event.preventDefault();
                try {
                    // Dapatkan URL share (bukan direct download)
                  const shareResponse = await fetch(`/api/files/${item.id}/share`);
                    if (!shareResponse.ok) {
                      const errorData = await shareResponse.json();
                      throw new Error(errorData.message || 'Gagal mendapatkan URL share.');
                    }
                    const shareData = await shareResponse.json();

                  // Tampilkan URL share (gunakan cara yang lebih baik daripada alert)
                  alert('Bagikan link ini: ' + shareData.shareUrl);

                  } catch (error) {
                      console.error('Gagal mendownload atau mendapatkan URL share:', error);
                      alert('Terjadi kesalahan.');
                  }

          });

          kontainerFile.appendChild(fileLink);

          const infoCount = document.createElement('div');
          infoCount.classList.add('info-count');

        //   const downloadCount = document.createElement('span');
        //   downloadCount.classList.add('download-count');
        //   downloadCount.textContent = item.downloadCount;
        //   infoCount.appendChild(downloadCount);

          const likeCount = document.createElement('span');
          likeCount.classList.add('like-count');
          likeCount.textContent = item.likes; // Gunakan item.likes

            // Cek apakah sudah like
            if (item.likedBy && item.likedBy.includes(getUserIP())) { // Fungsi getUserIP()
                likeCount.classList.add('liked');
            }

          likeCount.addEventListener('click', async () => {
              try {
                  const response = await fetch(`/api/files/${item.id}/like`, { method: 'POST' });
                    if (response.ok) {
                      const data = await response.json();
                        likeCount.textContent = data.likes;
                        if (data.liked) {
                            likeCount.classList.add('liked');
                        } else {
                            likeCount.classList.remove('liked');
                        }
                    } else {
                      const errorData = await response.json();
                      alert(errorData.message || "Gagal Like File");
                    }
                } catch (error) {
                    console.error('Gagal like:', error);
                }
          });
          infoCount.appendChild(likeCount);

            // --- Tombol Share ---
          const tombolShare = document.createElement('button');
          tombolShare.classList.add('tombol-share');
          tombolShare.innerHTML = '<i class="fas fa-share"></i>'; // Ikon share
          tombolShare.addEventListener('click', async () => {
              try {
                  const response = await fetch(`/api/files/${item.id}/share`);
                  if (response.ok) {
                      const data = await response.json();
                      alert('Bagikan link ini: ' + data.shareUrl); // Tampilkan URL share
                  } else {
                  const errorData = await response.json();
                  alert(errorData.message || "Gagal Generate Link Share");
                  }
              } catch (error) {
                  console.error('Gagal mendapatkan URL share:', error);
              }
          });
          infoCount.appendChild(tombolShare);
          kontainerFile.appendChild(infoCount);
          containerFile.appendChild(kontainerFile);

          gsap.from(kontainerFile, { duration: 0.5, opacity: 0, y: 50, ease: "power2.out", delay: 0.2 });
        }


        async function ambilDataFile() {
            try {
                const response = await fetch('/api/files');
                if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
                const data = await response.json();
                 // Urutkan (jika perlu)
                data.sort((a, b) => b.timestamp - a.timestamp);
                data.forEach(item => { buatKontainerFile(item); });
            } catch (error) { console.error('Gagal mengambil data:', error); }
        }

        // Fungsi untuk mendapatkan IP user (contoh, perlu disesuaikan)
        function getUserIP() {
            // Implementasi ini sangat sederhana dan mungkin tidak akurat.
            // Dalam aplikasi nyata, Anda akan mendapatkan IP dari header
            // request, atau menggunakan library seperti `request-ip`.
            return '127.0.0.1'; // Ganti dengan cara yang benar untuk mendapatkan IP
            // return '192.168.1.120';
        }
        document.addEventListener('DOMContentLoaded', () => {
            ambilDataKode();
            ambilDataFile();
        });
    </script>
</body>
</html>
