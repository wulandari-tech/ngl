<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Share</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- <link rel="stylesheet" href="style.css"> --> <!-- Jika Anda memisahkan CSS -->
    <style>
        /* CSS Reset (Minimal) */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: sans-serif; line-height: 1.6; background-color: #f4f4f4; color: #333; }
        .container { max-width: 1100px; margin: auto; padding: 20px; }
        header { background: #333; color: #fff; padding: 1rem 0; text-align: center; }
        header h1 { margin: 0; }
        #kode-list, #file-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .kode-item, .file-item { border: 1px solid #ddd; padding: 15px; border-radius: 5px; background-color: #fff; }
        .kode-item h2, .file-item h2 { margin-bottom: 10px; font-size: 1.2em; }
        .kode-item pre { background-color: #f0f0f0; padding: 10px; border-radius: 3px; overflow-x: auto; white-space: pre-wrap; }
        .kode-item .meta, .file-item .meta  { font-size: 0.8em; color: #666; margin-top: 10px; }
        .comments-section { margin-top: 15px; }
        .comments-section h3 { font-size: 1em; margin-bottom: 5px; }
        .comment { border-bottom: 1px solid #eee; padding: 8px 0; }
        .comment .author { font-weight: bold; }
        .comment .text { margin-top: 5px;}
        .add-comment { margin-top: 10px;}
        .add-comment input, .add-comment textarea { width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;}
        .add-comment button { background-color: #333; color: #fff; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; }
        .add-comment button:hover{background-color: #111;}

        /* Dark Mode Styles (Optional) */
        body.dark-mode { background-color: #121212; color: #eee; }
        body.dark-mode .kode-item, body.dark-mode .file-item { background-color: #222; border-color: #444; }
        body.dark-mode .kode-item pre { background-color: #333; }
        body.dark-mode .comment { border-bottom-color: #444; }
        .dark-mode-toggle {
          position: fixed;
          top: 10px;
          right: 10px;
          background-color: #000; /* Hitam Pekat */
          color: #fff;
          border: none;
          padding: 5px 10px;
          border-radius: 50%; /* Bentuk lingkaran */
          cursor: pointer;
          font-size: 1.5em; /* Ukuran emoji */
          line-height: 1; /* Pusatkan emoji */
        }
        body.dark-mode .dark-mode-toggle {
            background-color: #fff;
            color: #000;
        }

        /* Style untuk File List */
        .file-item {
            display: flex;
            flex-direction: column;
        }

        .file-item a {
            color: #007bff;
            text-decoration: none;
        }

        .file-item a:hover {
            text-decoration: underline;
        }

        .file-item .meta {
            margin-top: auto; /* Dorong meta ke bawah */
        }


    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>Code Share</h1>
            <p>Bagikan dan temukan potongan kode dan file.</p>
        </div>
    </header>

    <main class="container">
        <button class="dark-mode-toggle" onclick="toggleDarkMode()">
            <span id="dark-mode-icon">üåô</span>
        </button>

        <h2>Kode Terbaru</h2>
        <div id="kode-list">
            <!-- Kode akan ditampilkan di sini -->
        </div>

        <h2>File Terbaru</h2>
        <div id="file-list">
            <!-- File akan ditampilkan di sini -->
        </div>
    </main>

    <script>

    // --- Bagian Kode (Tidak banyak berubah) ---
    async function getKode() {
        try {
            const response = await fetch('/api/kode');
            if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
            const data = await response.json();
            displayKode(data);
        } catch (error) {
            console.error('Error fetching kode:', error);
            displayError('Gagal mengambil data kode.');
        }
    }

        // ... (fungsi displayKode, getComments, displayComments, addComment, getCommentsFromDom, displayError, escapeHtml - tidak berubah)
    // Fungsi untuk menampilkan kode di halaman
    function displayKode(kodeList) {
        const kodeListDiv = document.getElementById('kode-list');
        kodeListDiv.innerHTML = ''; // Kosongkan list

        if (kodeList.length === 0) {
            kodeListDiv.innerHTML = '<p>Belum ada kode yang dibagikan.</p>';
            return;
        }

        kodeList.forEach(kodeItem => {
            const kodeDiv = document.createElement('div');
            kodeDiv.classList.add('kode-item');
            kodeDiv.innerHTML = `
                <h2>${escapeHtml(kodeItem.judul)}</h2>
                <pre><code>${escapeHtml(kodeItem.kode)}</code></pre>
                <div class="meta">
                    <span>ID: ${kodeItem.id}</span> |
                    <span>Timestamp: ${new Date(kodeItem.timestamp).toLocaleString()}</span> |
                    <span>Likes: ${kodeItem.likes}</span> |
                    <span>Copies: ${kodeItem.copyCount}</span>
                </div>
                <div class="comments-section">
                    <h3>Komentar:</h3>
                    <div class="comments-list"></div>
                    <div class="add-comment">
                        <input type="text" class="comment-author" placeholder="Nama Anda">
                        <textarea class="comment-text" placeholder="Tambahkan komentar..."></textarea>
                        <button onclick="addComment(${kodeItem.id})">Kirim Komentar</button>
                    </div>
                </div>
            `;

            kodeListDiv.appendChild(kodeDiv);
            getComments(kodeItem.id); // Ambil komentar untuk setiap kode
        });
    }

    // Fungsi untuk mengambil komentar dari API
    async function getComments(kodeId) {
      try {
        const response = await fetch(`/api/kode/${kodeId}/comments`);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const comments = await response.json();
        displayComments(kodeId, comments);
      } catch (error) {
        console.error('Error fetching comments:', error);
      }
    }

    // Fungsi untuk menampilkan komentar
    function displayComments(kodeId, comments) {
      const commentsListDiv = document.querySelector(`.kode-item:has(button[onclick="addComment(${kodeId})"]) .comments-list`); //Cari comment list yang sesuai dengan kode id

        if (!commentsListDiv) {
            console.error("commentsListDiv not found for kodeId:", kodeId);
            return;
        }

      commentsListDiv.innerHTML = ''; // Kosongkan list komentar

      if (comments.length === 0) {
        commentsListDiv.innerHTML = '<p>Belum ada komentar.</p>';
        return;
      }

      comments.forEach(comment => {
        const commentDiv = document.createElement('div');
        commentDiv.classList.add('comment');
        commentDiv.innerHTML = `
          <span class="author">${escapeHtml(comment.author)}:</span>
          <span class="text">${escapeHtml(comment.text)}</span>
          <span class="timestamp">${new Date(comment.timestamp).toLocaleString()}</span>
        `;
        commentsListDiv.appendChild(commentDiv);
      });
    }


    //Fungsi untuk menambahkan komentar
    async function addComment(kodeId) {
        const authorInput = document.querySelector(`.kode-item:has(button[onclick="addComment(${kodeId})"]) .comment-author`);
        const textInput = document.querySelector(`.kode-item:has(button[onclick="addComment(${kodeId})"]) .comment-text`);

        const author = authorInput.value;
        const text = textInput.value;

        if (!author || !text) {
            alert('Nama dan komentar harus diisi!');
            return;
        }

          try {
            const response = await fetch(`/api/kode/${kodeId}/comments`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({ author, text }),
            });

            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }

            const newComment = await response.json();
            // Tambahkan komentar ke tampilan (tanpa perlu fetch ulang)
            displayComments(kodeId, [ ...getCommentsFromDom(kodeId), newComment]);
            authorInput.value = ''; // Kosongkan input
            textInput.value = '';
          } catch (error) {
            console.error('Error adding comment:', error);
            displayError('Gagal menambahkan komentar.');
          }
      }

    // Helper function untuk mengambil comments dari DOM
    function getCommentsFromDom(kodeId) {
      const commentsListDiv = document.querySelector(`.kode-item:has(button[onclick="addComment(${kodeId})"]) .comments-list`);
      const comments = [];
        if(commentsListDiv){
            commentsListDiv.querySelectorAll('.comment').forEach(commentDiv => {
                const author = commentDiv.querySelector('.author').textContent.replace(":", "").trim();
                const text = commentDiv.querySelector('.text').textContent;
                comments.push({author, text});
            });
        }
        return comments;
    }


    // Fungsi untuk menampilkan pesan error
    function displayError(message) {
        const kodeListDiv = document.getElementById('kode-list');
        kodeListDiv.innerHTML = `<p style="color: red;">${message}</p>`;
    }

     // Helper function untuk escape HTML entities
    function escapeHtml(unsafe) {
        return unsafe
            .replace(/&/g, "&")
            .replace(/</g, "<")
            .replace(/>/g, ">")
            .replace(/"/g, """)
            .replace(/'/g, "'");
    }

    // --- Bagian File (Baru) ---

    async function getFiles() {
        try {
            const response = await fetch('/api/files');
            if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
            const data = await response.json();
            displayFiles(data);
        } catch (error) {
            console.error('Error fetching files:', error);
            displayError('Gagal mengambil daftar file.');
        }
    }

    function displayFiles(fileList) {
        const fileListDiv = document.getElementById('file-list');
        fileListDiv.innerHTML = '';

        if (fileList.length === 0) {
            fileListDiv.innerHTML = '<p>Belum ada file yang dibagikan.</p>';
            return;
        }

        fileList.forEach(fileItem => {
            const fileDiv = document.createElement('div');
            fileDiv.classList.add('file-item');
            fileDiv.innerHTML = `
                <h2><a href="${escapeHtml(fileItem.url)}" target="_blank">${escapeHtml(fileItem.name)}</a></h2>
                <div class="meta">
                    <span>ID: ${fileItem.id}</span> |
                    <span>Timestamp: ${new Date(fileItem.timestamp).toLocaleString()}</span> |
                    <span>Downloads: ${fileItem.downloadCount}</span>
                </div>
            `;
            fileListDiv.appendChild(fileDiv);
        });
    }


    // --- Dark Mode ---
    function toggleDarkMode() {
        const body = document.body;
        body.classList.toggle('dark-mode');
        const isDarkMode = body.classList.contains('dark-mode');
        document.getElementById('dark-mode-icon').textContent = isDarkMode ? '‚òÄÔ∏è' : 'üåô';
        localStorage.setItem('darkMode', isDarkMode);
    }

    document.addEventListener('DOMContentLoaded', () => {
        const isDarkMode = localStorage.getItem('darkMode') === 'true';
        if (isDarkMode) {
            document.body.classList.add('dark-mode');
            document.getElementById('dark-mode-icon').textContent = '‚òÄÔ∏è';
        }
        getKode();
        getFiles(); // Ambil daftar file
    });

    </script>
</body>
</html>
