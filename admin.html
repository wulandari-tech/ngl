<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Code Share</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- <link rel="stylesheet" href="style.css"> --> <!-- Jika Anda memisahkan CSS -->

    <style>
        /* CSS Reset (Minimal) */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: sans-serif; line-height: 1.6; background-color: #f4f4f4; color: #333; }
        .container { max-width: 1100px; margin: auto; padding: 20px; }
        header { background: #333; color: #fff; padding: 1rem 0; text-align: center; }
        h1 { margin-bottom: 20px; }
        #add-kode-form { margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 5px; background-color:#fff; }
        #add-kode-form input, #add-kode-form textarea { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px; }
        #add-kode-form button { background-color: #333; color: #fff; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; }
        #add-kode-form button:hover{ background-color: #111;}
        #kode-list { margin-top: 20px;}
        .kode-item { border: 1px solid #ddd; padding: 15px; margin-bottom:15px; border-radius: 5px; background-color: #fff; }
        .kode-item h2 { margin-bottom: 10px; font-size: 1.2em; }
        .kode-item pre { background-color: #f0f0f0; padding: 10px; border-radius: 3px; overflow-x: auto; white-space: pre-wrap; }
        .kode-item .meta { font-size: 0.8em; color: #666; margin-top: 10px; }
        .kode-item .actions { margin-top: 10px; }
        .kode-item .actions button { background-color: #dc3545; color: #fff; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; margin-right:5px;}
        .kode-item .actions button:hover{opacity: 0.8;}

         /* Dark Mode Styles (Optional) */
        body.dark-mode { background-color: #121212; color: #eee; }
        body.dark-mode #add-kode-form { background-color: #222; border-color: #444; }
        body.dark-mode .kode-item { background-color: #222; border-color: #444; }
        body.dark-mode .kode-item pre { background-color: #333; }
       .dark-mode-toggle {
          position: fixed;
          top: 10px;
          right: 10px;
          background-color: #000; /* Hitam Pekat */
          color: #fff;
          border: none;
          padding: 5px 10px;
          border-radius: 50%; /* Bentuk lingkaran */
          cursor: pointer;
          font-size: 1.5em; /* Ukuran emoji */
          line-height: 1; /* Pusatkan emoji */
        }
        body.dark-mode .dark-mode-toggle {
            background-color: #fff;
            color: #000;
        }

    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>Admin - Code Share</h1>
        </div>
    </header>
     <main class="container">
       <button class="dark-mode-toggle" onclick="toggleDarkMode()">
            <span id="dark-mode-icon">üåô</span>
        </button>

        <section id="add-kode-form">
            <h2>Tambah Kode Baru</h2>
            <input type="text" id="judul-input" placeholder="Judul Kode">
            <textarea id="kode-input" placeholder="Kode..."></textarea>
            <button onclick="addKode()">Tambahkan Kode</button>
        </section>

        <section id="kode-list">
            <h2>Daftar Kode</h2>
            <!-- Daftar kode akan ditampilkan di sini -->
        </section>
    </main>

    <script>
       // Fungsi untuk mengambil data kode dari API
        async function getKode() {
            try {
                const response = await fetch('/api/kode');
                if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`);}
                const data = await response.json();
                displayKode(data);
            } catch (error) {
                console.error('Error fetching kode:', error);
                displayError('Gagal mengambil data kode.');
            }
        }

        // Fungsi untuk menampilkan kode di halaman admin
        function displayKode(kodeList) {
            const kodeListDiv = document.getElementById('kode-list');
            kodeListDiv.innerHTML = ''; // Kosongkan list

            if (kodeList.length === 0) {
                kodeListDiv.innerHTML = '<p>Belum ada kode yang dibagikan.</p>';
                return;
            }

            kodeList.forEach(kodeItem => {
                const kodeDiv = document.createElement('div');
                kodeDiv.classList.add('kode-item');
                kodeDiv.innerHTML = `
                    <h2>${escapeHtml(kodeItem.judul)}</h2>
                    <pre><code>${escapeHtml(kodeItem.kode)}</code></pre>
                    <div class="meta">
                        <span>ID: ${kodeItem.id}</span> |
                        <span>Timestamp: ${new Date(kodeItem.timestamp).toLocaleString()}</span>
                    </div>
                    <div class="actions">
                        <button onclick="deleteKode(${kodeItem.id})">Hapus</button>
                    </div>
                `;
                kodeListDiv.appendChild(kodeDiv);
            });
        }

        // Fungsi untuk menambahkan kode baru
        async function addKode() {
            const judulInput = document.getElementById('judul-input');
            const kodeInput = document.getElementById('kode-input');
            const judul = judulInput.value;
            const kode = kodeInput.value;

            if (!judul || !kode) {
                alert('Judul dan kode harus diisi!');
                return;
            }

            try {
                const response = await fetch('/api/kode', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ judul, kode }),
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const newKode = await response.json();
                // Tambahkan kode ke tampilan (tanpa perlu fetch ulang)
                displayKode([newKode, ...getKodeFromDom()]); //Prepend, kode baru di atas.
                judulInput.value = ''; // Kosongkan input
                kodeInput.value = '';
            } catch (error) {
                console.error('Error adding kode:', error);
                displayError('Gagal menambahkan kode.');
            }
        }


       // Helper untuk mendapatkan kode dari DOM
        function getKodeFromDom(){
            const kodeListDiv = document.getElementById('kode-list');
            const kodeItems = [];
            kodeListDiv.querySelectorAll('.kode-item').forEach(item => {
                const judul = item.querySelector('h2').textContent;
                const kode = item.querySelector('pre code').textContent;
                const id = parseInt(item.querySelector('.meta span:first-child').textContent.replace("ID: ", "")); // Ambil ID

                kodeItems.push({id, judul, kode});
            });
            return kodeItems;
        }

        // Fungsi untuk menghapus kode
        async function deleteKode(id) {
          if (!confirm('Apakah Anda yakin ingin menghapus kode ini?')) {
            return;
          }

          try {
            const response = await fetch(`/api/kode/${id}`, {
              method: 'DELETE',
            });

            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }

             // Hapus kode dari tampilan
            const kodeItem = document.querySelector(`.kode-item:has(button[onclick="deleteKode(${id})"])`); //Cari item berdasarkan tombol hapus.
                if(kodeItem){
                   kodeItem.remove();
                }


          } catch (error) {
            console.error('Error deleting kode:', error);
            displayError('Gagal menghapus kode.');
          }
        }

        // Fungsi untuk menampilkan pesan error
        function displayError(message) {
            const kodeListDiv = document.getElementById('kode-list');
            kodeListDiv.innerHTML = `<p style="color: red;">${message}</p>`;
        }
        // Helper function untuk escape HTML entities
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&")
                .replace(/</g, "<")
                .replace(/>/g, ">")
                .replace(/"/g, """)
                .replace(/'/g, "'");
        }



        // --- Dark Mode ---
        function toggleDarkMode() {
            const body = document.body;
            body.classList.toggle('dark-mode');
            const isDarkMode = body.classList.contains('dark-mode');
            document.getElementById('dark-mode-icon').textContent = isDarkMode ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('darkMode', isDarkMode);
        }

        document.addEventListener('DOMContentLoaded', () => {
            const isDarkMode = localStorage.getItem('darkMode') === 'true';
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
                document.getElementById('dark-mode-icon').textContent = '‚òÄÔ∏è';
            }
            getKode();
        });

    </script>
</body>
</html>
